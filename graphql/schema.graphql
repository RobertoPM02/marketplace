# ---------------------------------------------------
# SCALARS
# ---------------------------------------------------

"A datetime string with format `Y-m-d H:i:s`, e.g. `2018-05-23 13:43:32`."
scalar DateTime @scalar(class: "Nuwave\\Lighthouse\\Schema\\Types\\Scalars\\DateTime")

scalar Upload @scalar(class: "Nuwave\\Lighthouse\\Schema\\Types\\Scalars\\Upload")

#scalar JSON @scalar(class: "Nuwave\\Lighthouse\\Schema\\Types\\Scalars\\JSON")

# ---------------------------------------------------
# QUERY ROOT
# ---------------------------------------------------

type Query {
    # --- Usuarios ---
    user(
        id: ID @eq @rules(apply: ["prohibits:email", "required_without:email"])
        email: String @eq @rules(apply: ["prohibits:id", "required_without:id", "email"])
    ): User @find

    users(
        name: String @where(operator: "like")
    ): [User!]! @paginate(defaultCount: 10)

    # --- Productos ---
    product(id: ID @eq): Product @find

    products: [Product!]! @all

    allProducts: [Product!]! @paginate(defaultCount: 10)

    viewProductsById(
        id: ID @eq @rules(apply: ["required"])
    ): Product @field(resolver: "App\\GraphQL\\Queries\\ViewProduct")

    # --- Carrito ---
    myCart: Cart
        @field(resolver: "App\\GraphQL\\Queries\\MyCart")
        @guard(with: ["sanctum"])

    # --- Perfil ---
    # Query para obtener MI perfil (requiere login)
    me: User!
        @guard(with: ["sanctum"])
        @auth
}

# ---------------------------------------------------
# MUTATION ROOT
# ---------------------------------------------------

type Mutation {
    # --- Auth & Registro ---
    createUser(
        name: String!
        email: String! @rules(apply: ["email", "unique:users,email"])
        number: String! @rename(attribute: "phone_number") @rules(apply: ["min:10", "max:15", "unique:users,phone_number"])
        password: String! @hash @rules(apply: ["required", "regex:/^(?=.*[A-Z])(?=.*[0-9]).{6,}$/"])
        role_id: ID! @rules(apply: ["exists:roles,id"])
    ): User @field(resolver: "App\\GraphQL\\Mutations\\CreateUser")

    login(
        login: String! @rules(apply: ["required"])
        password: String! @rules(apply: ["required", "min:8"])
    ): AuthPayload @field(resolver: "App\\GraphQL\\Mutations\\Login")

    logout: Boolean! @field(resolver: "App\\GraphQL\\Mutations\\Logout")

    # --- Perfil de Usuario (NUEVO) ---
    updateProfile(
        name: String @rules(apply: ["min:3", "max:50"])
        phone_number: String @rules(apply: ["numeric", "digits_between:10,15"])
    ): ProfileUpdateResponse!
        @field(resolver: "App\\GraphQL\\Mutations\\UpdateProfile")
        @guard(with: ["sanctum"])

    # --- Productos ---
    createProduct(
        name: String! @rules(apply: ["required", "min:3"])
        price: Float! @rules(apply: ["required", "numeric", "min:0"])
        image: Upload @rules(apply: ["image", "max:2048"])
    ): Product!
        @field(resolver: "App\\GraphQL\\Mutations\\CreateProduct")
        @guard(with: ["sanctum"])

    # --- Carrito ---
    addToCart(
        product_id: ID!
        quantity: Int = 1
    ): Cart
        @field(resolver: "App\\GraphQL\\Mutations\\AddToCart")
        @guard(with: ["sanctum"])

    updateCartItem(
        cart_item_id: ID!
        quantity: Int!
    ): Cart
        @field(resolver: "App\\GraphQL\\Mutations\\UpdateCartItem")
        @guard(with: ["sanctum"])

    removeFromCart(
        cart_item_id: ID!
    ): Cart
        @field(resolver: "App\\GraphQL\\Mutations\\RemoveFromCart")
        @guard(with: ["sanctum"])

    # --- Checkout ---
    checkout: CheckoutResponse!
        @field(resolver: "App\\GraphQL\\Mutations\\Checkout")
        @guard(with: ["sanctum"])

}

# ---------------------------------------------------
# OBJECT TYPES
# ---------------------------------------------------

type User {
    id: ID!
    name: String!
    email: String!
    number: String! @rename(attribute: "phone_number")
    email_verified_at: DateTime
    created_at: DateTime!
    updated_at: DateTime!
    role: Role @belongsTo
    
    # NUEVO: Para ver mis ventas (productos publicados)
    products: [Product!]! @hasMany
}

type Role {
    id: ID!
    name: String!
}

type AuthPayload {
    access_token: String!
    token_type: String!
    user: User!
}

type Product {
    id: ID!
    name: String!
    price: Float!
    image: String @rename(attribute: "image_url")
    created_at: DateTime!
    updated_at: DateTime!
    user_id: ID
    user: User @belongsTo
}

type Cart {
    id: ID!
    items: [CartItem!]! @hasMany
    subtotal: Float!
    shipping: Float!
    taxes: Float!
    total: Float!
}

type CartItem {
    id: ID!
    product: Product!
    quantity: Int!
}

type CheckoutResponse {
    status: String!
    message: String!
    total_paid: Float!
}


# NUEVO: Respuesta para la actualizaci√≥n de perfil
type ProfileUpdateResponse {
    status: String!
    message: String!
    user: User!
}